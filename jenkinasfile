pipeline {
    agent any

    tools {
        nodejs 'node21'
    }

    environment {
        SCANNER_HOME = tool 'sonarqube'
        OWASP_HOME = 'Dependency-Check'
        DOCKERHUB_CREDENTIALS = 'dockerhub-to-jenkins' 
        DOCKERHUB_USERNAME = 'subhabrata3002' 
        PUBLIC_REPO = "${JOB_NAME}/public-repo" 
        SERVER_REPO = "${JOB_NAME}/server-repo" 
    }

    stages {
        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }
        
         stage('GitHub Checkout') {
            steps {
                // Checkout code from GitHub branch 'correct'
                git url: 'https://github.com/Subhabrata2468/chat-app-react-nodejs-devops-project-2.git', branch: 'correct'
            }
        }
        
        stage('Install Dependency') {
            steps {
                // Run npm install in the server directory
                dir('server') {
                    sh 'npm install'
                }
                // Run npm install in the public directory
                dir('public') {
                    sh 'npm install'
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('sonarqube') {
                    sh "${SCANNER_HOME}/bin/sonar-scanner -Dsonar.projectName=${JOB_NAME} -Dsonar.projectKey=${JOB_NAME}"
                }
            }
        }
        
        
        
        
        stage('Trivy File Scan') {
            steps {
		        script {
                    def reportMainFolder = "TESTING"
                    def reportDir = "${workspace}/${reportMainFolder}/Trivy-fileScan-check-report"
		
		            // Ensure the directory exists
                    sh "mkdir -p ${reportDir}"
                    sh "chmod -R 777 ${reportDir}"
		
		            // File Scan using Trivy
                    sh "trivy fs --format table -o ${reportDir}/trivy-fs-report.html ."
		        }
            }
        }
        


        stage('Docker Build & Push Public') {
            steps {
                script {
                    withDockerRegistry(credentialsId: DOCKERHUB_CREDENTIALS) {
                        // Build the Docker image for the public directory
                        sh "docker build -t ${PUBLIC_REPO}:v1.${BUILD_ID} public"

                        // Tag and push the Docker image to Docker Hub
                        sh "docker tag ${PUBLIC_REPO}:v1.${BUILD_ID} ${DOCKERHUB_USERNAME}/snappy-public-repo:v1.${BUILD_ID}"
                        sh "docker tag ${PUBLIC_REPO}:v1.${BUILD_ID} ${DOCKERHUB_USERNAME}/snappy-public-repo:latest"
                        sh "docker push ${DOCKERHUB_USERNAME}/snappy-public-repo:v1.${BUILD_ID}"
                        sh "docker push ${DOCKERHUB_USERNAME}/snappy-public-repo:latest"
                    }
                }
            }
        }

        stage('Docker Build & Push Server') {
            steps {
                script {
                    withDockerRegistry(credentialsId: DOCKERHUB_CREDENTIALS) {
                        // Build the Docker image for the server directory
                        sh "docker build -t ${SERVER_REPO}:v1.${BUILD_ID} server"

                        // Tag and push the Docker image to Docker Hub
                        sh "docker tag ${SERVER_REPO}:v1.${BUILD_ID} ${DOCKERHUB_USERNAME}/snappy-server-repo:v1.${BUILD_ID}"
                        sh "docker tag ${SERVER_REPO}:v1.${BUILD_ID} ${DOCKERHUB_USERNAME}/snappy-server-repo:latest"
                        sh "docker push ${DOCKERHUB_USERNAME}/snappy-server-repo:v1.${BUILD_ID}"
                        sh "docker push ${DOCKERHUB_USERNAME}/snappy-server-repo:latest"
                    }
                }
            }
        }
        
        stage('Scan Docker Images with Trivy') {
            steps {
                script {
                    def reportMainFolder = "TESTING"
                    def reportDir = "${workspace}/${reportMainFolder}/Trivy-Docker-image-check-report"

                    // Ensure the directory exists
                    sh "mkdir -p ${reportDir}"
                    sh "chmod -R 777 ${reportDir}"

                    // Scan the Docker image using Trivy
                    sh "trivy image ${DOCKERHUB_USERNAME}/snappy-public-repo:v1.${BUILD_ID} > ${reportDir}/Trivy-Snappy-Public-image.txt"
		    sh "trivy image ${DOCKERHUB_USERNAME}/snappy-server-repo:v1.${BUILD_ID} > ${reportDir}/Trivy-Snappy-Server-image.txt"
                }
            }
        }
       
        stage("Create Namespace for Kubernetes") {
            steps {
                script {
                    withKubeCredentials(kubectlCredentials: [
                        [
                            caCertificate: '',            
                            clusterName: 'snappy-cluster-2',         
                            contextName: '',              
                            credentialsId: 'eks-to-jenkins',
                            namespace: '',         
                            serverUrl: 'https://150DB9C720FB273F7CF2094880F84199.yl4.us-east-1.eks.amazonaws.com'
                        ]
                    ]) {
                        try {
                            // Attempt to create the namespace
                            sh "kubectl create namespace snappy"
                        } catch (Exception e) {
                            // If the namespace already exists, log the error and proceed
                            echo 'Namespace already exists. Proceeding...'
                        }

                        try {
                            // Attempt to create the namespace
                            sh "kubectl create namespace prometheus-node-exporter"
                        } catch (Exception e) {
                            // If the namespace already exists, log the error and proceed
                            echo 'Namespace already exists. Proceeding...'
                        }
                    }
                }
            }
        }

        stage("Deployment of snappy Namespace") {
            steps {
                script {
                    dir('Kubernetes') {
                        withKubeCredentials(kubectlCredentials: [
                            [
                                caCertificate: '',            
                                clusterName: 'snappy-cluster-2',         
                                contextName: '',              
                                credentialsId: 'eks-to-jenkins',
                                namespace: 'snappy',         
                                serverUrl: 'https://150DB9C720FB273F7CF2094880F84199.yl4.us-east-1.eks.amazonaws.com'
                            ]
                        ]) {
                            sh 'chmod +x snappy-apply.sh'
                            sh './snappy-apply.sh'
                        }
                    }
                }
            }
        }
         
        stage("Deployment of prometheus-node-exporter Namespace") {
            steps {
                script {
                    dir('Kubernetes') {
                        withKubeCredentials(kubectlCredentials: [
                            [
                                caCertificate: '',            
                                clusterName: 'snappy-cluster-2',         
                                contextName: '',              
                                credentialsId: 'eks-to-jenkins',
                                namespace: 'prometheus-node-exporter',         
                                serverUrl: 'https://150DB9C720FB273F7CF2094880F84199.yl4.us-east-1.eks.amazonaws.com'
                            ]
                        ]) {
                            sh 'kubectl apply -f nodeport.yml'
                        }
                    }
                }
            }
        }
    }    

    post {
        always {
            // Cleanup Docker images to free up space
            sh "docker rmi ${PUBLIC_REPO}:v1.${BUILD_ID} || true"
            sh "docker rmi ${SERVER_REPO}:v1.${BUILD_ID} || true"
            sh "docker rmi ${DOCKERHUB_USERNAME}/snappy-public-repo:v1.${BUILD_ID} || true"
            sh "docker rmi ${DOCKERHUB_USERNAME}/snappy-public-repo:latest || true"
            sh "docker rmi ${DOCKERHUB_USERNAME}/snappy-server-repo:v1.${BUILD_ID} || true"
            sh "docker rmi ${DOCKERHUB_USERNAME}/snappy-server-repo:latest || true"

            // Send email for every build
            emailext subject: "Pipeline: ${currentBuild.fullDisplayName}",
                     body: "The Jenkins pipeline ${currentBuild.fullDisplayName} has completed. Please check the console output for more details.",
                     to: "watchwolverine2468@gmail.com",
                     attachmentsPattern: 'TESTING/Trivy-fileScan-check-report/trivy-fs-report.html, TESTING/Trivy-Docker-image-check-report/Trivy-Snappy-Public-image.txt, TESTING/Trivy-Docker-image-check-report/Trivy-Snappy-Server-image.txt'
        }
        failure {
            // Send email on pipeline failure
            emailext subject: "Pipeline Failed: ${currentBuild.fullDisplayName}",
                     body: "The Jenkins pipeline ${currentBuild.fullDisplayName} failed. Please check the console output for more details.",
                     to: "watchwolverine2468@gmail.com",
                     attachmentsPattern: 'TESTING/Trivy-fileScan-check-report/trivy-fs-report.html, TESTING/Trivy-Docker-image-check-report/Trivy-Snappy-Public-image.txt, TESTING/Trivy-Docker-image-check-report/Trivy-Snappy-Server-image.txt'
        }
    }
}
